{% extends "base.html" %}

{% block title %}Edit All Secrets: {{ env }}{% endblock %}

{% block head_extra %}
<script>
  // JavaScript for real-time search and cross-environment suggestions
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('secretSearch');
    const tableBody = document.querySelector('#secretsTable tbody');
    const rows = tableBody ? tableBody.querySelectorAll('tr') : [];
    const suggestionBox = document.getElementById('suggestionBox');
    const currentEnv = "{{ env }}"; // Get the current environment from Flask

    if (!searchInput || !tableBody) {
        console.error("Search input or table body not found.");
        return;
    }

    searchInput.addEventListener('input', function() {
      const searchTerm = searchInput.value.toLowerCase();
      let visibleRowCount = 0;

      rows.forEach(row => {
        const keyCell = row.cells[0];
        const valueCell = row.cells[1];
        if (keyCell && valueCell) {
          const keyText = keyCell.textContent.toLowerCase();
          const valueInput = valueCell.querySelector('input[name="values"]');
          const valueText = valueInput ? valueInput.value.toLowerCase() : '';

          // Check if search term is in key or value
          if (keyText.includes(searchTerm) || valueText.includes(searchTerm)) {
            row.style.display = ''; // Show row
            visibleRowCount++;
          } else {
            row.style.display = 'none'; // Hide row
          }
        }
      });

      // Check for suggestions in other environments if no results found locally
      if (searchTerm.length > 0 && visibleRowCount === 0) {
          fetchSuggestions(searchTerm);
      } else {
          suggestionBox.innerHTML = ''; // Clear suggestions if results are found or search term is empty
      }
    });

    function fetchSuggestions(searchTerm) {
        // Make an asynchronous request to the Flask endpoint
        fetch(`/search_other_envs?current_env=${currentEnv}&search_term=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                displaySuggestions(data);
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
                suggestionBox.innerHTML = '<p class="text-red-600 text-sm mt-2">Error fetching suggestions.</p>';
            });
    }

    function displaySuggestions(envs) {
        suggestionBox.innerHTML = ''; // Clear previous suggestions
        if (envs.length > 0) {
            const suggestionText = document.createElement('p');
            suggestionText.className = 'text-gray-600 text-sm mt-2';
            suggestionText.textContent = 'Found in other environments: ';
            suggestionBox.appendChild(suggestionText);

            envs.forEach((env, index) => {
                const envLink = document.createElement('a');
                envLink.href = `{{ url_for('show_all', env='_ENV_') }}`.replace('_ENV_', env);
                envLink.className = 'text-blue-600 hover:underline text-sm';
                envLink.textContent = env;
                suggestionBox.appendChild(envLink);
                if (index < envs.length - 1) {
                    suggestionBox.appendChild(document.createTextNode(', '));
                }
            });
        }
    }

  });
</script>
{% endblock %}

{% block content %}
  <div class="bg-white p-6 rounded-lg shadow-md">
    <h1 class="text-2xl font-bold text-blue-700 mb-4">Edit All Secrets (<span class="font-semibold">{{ env }}</span>)</h1>
    <p class="text-sm text-gray-600 mb-4">Edit the decoded values for all secrets in this environment. Click "Update All" to save your changes (values will be re-encoded). You can also delete individual secrets or add new ones below.</p>

    <div class="mb-6 border-b pb-6">
       <h3 class="text-lg font-medium text-gray-700 mb-3">Add New Secret</h3>
       <p class="text-sm text-gray-600 mb-4">Add a new secret key-value pair to this environment. The value will be automatically Base64 encoded.</p>
       <form action="{{ url_for('add_secret') }}" method="post">
         <input type="hidden" name="env" value="{{ env }}">
         <input type="hidden" name="redirect_to" value="show_all"> {# Indicate where to redirect after adding #}
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
           <div>
             <label for="new_key" class="block text-sm font-medium text-gray-700 mb-2">Key:</label>
             <input type="text" id="new_key" name="key" placeholder="e.g. NEW_API_KEY" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
           </div>
           <div>
             <label for="new_value" class="block text-sm font-medium text-gray-700 mb-2">Value:</label>
             <input type="text" id="new_value" name="value" placeholder="e.g. new_secret_value" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
           </div>
           <div>
             <button type="submit" class="w-full px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Add Secret</button>
           </div>
         </div>
       </form>
    </div>


    <div class="mb-6">
        <h3 class="text-lg font-medium text-gray-700 mb-3">Secrets in this Environment</h3>
        <p class="text-sm text-gray-600 mb-4">Use the search box to filter secrets by key or value. You can edit values directly in the table.</p>
        <div class="mb-4">
            <label for="secretSearch" class="block text-sm font-medium text-gray-700 mb-2">Search Secrets:</label>
            <input type="text" id="secretSearch" placeholder="Search by key or value..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <div id="suggestionBox"></div> {# Area for suggestions #}
        </div>

        {% if decoded_list %}
        <div class="overflow-x-auto"> {# Add horizontal scroll on small screens if table is wide #}
          <table id="secretsTable" class="min-w-full divide-y divide-gray-200 mb-6 border border-gray-200 rounded-md overflow-hidden">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th> {# Added Actions column #}
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            {% for secret in decoded_list %} {# Iterate through list of dictionaries #}
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ secret.key }}</td> {# Access key using dot notation #}
                <td class="px-6 py-4 text-sm text-gray-500">
                  <input type="hidden" name="keys" value="{{ secret.key }}"> {# Access key using dot notation #}
                  <input type="text" name="values" value="{{ secret.value }}" class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"> {# Access value using dot notation #}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"> {# Actions column cell #}
                   <form action="{{ url_for('delete_secret') }}" method="post" onsubmit="return confirm('Are you sure you want to delete the secret \'{{ secret.key }}\'? This cannot be undone.');" class="inline-block"> {# Access key using dot notation #}
                      <input type="hidden" name="env" value="{{ env }}">
                      <input type="hidden" name="key" value="{{ secret.key }}"> {# Access key using dot notation #}
                      <button type="submit" class="px-4 py-2 bg-red-600 text-white text-xs font-semibold rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">Delete</button>
                   </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="flex gap-4">
          <button type="submit" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Update All Shown Secrets</button> {# Updated button text #}
          <button type="button" onclick="window.location='{{ url_for('index', env=env) }}'" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Back to Dashboard</button> {# Updated button text #}
        </div>
      {% else %}
       <p class="bg-yellow-100 text-yellow-800 p-4 rounded-md shadow-md mb-6">No secrets found in this environment yet.</p>
      {% endif %}
    </form>
  </div>
{% endblock %}
